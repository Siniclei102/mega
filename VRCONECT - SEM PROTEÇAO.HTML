<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", sans-serif;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            background: linear-gradient(to bottom right, #0a0f2c, #162b6f);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
        }

        .container {
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #9f6ff2, #f26fc7);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            text-align: center;
            font-size: 1rem;
            color: #ccc;
        }

        .select-server {
            padding: 25px !important;
            border-radius: 15px !important;
            font-size: 26px !important;
        }

        .select-server,
        .input-field {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .select-server:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .input-field.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-field.disabled input {
            cursor: not-allowed;
            pointer-events: none;
        }

        .input-field.hidden {
            display: none;
        }

        .select-server i,
        .input-field i {
            color: #fff;
        }

        .select-server input,
        .input-field input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
        }

        .input-field input {
            cursor: text;
        }

        .select-server input::placeholder,
        .input-field input::placeholder {
            color: #ccc;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            color: #f77;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .action-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .connect-btn {
            background-color: #e53935;
            color: #fff;
            padding: 0.9rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .connect-btn:hover {
            background-color: #d32f2f;
        }

        .connect-btn:focus {
            outline: none;
        }

        .connect-btn.connecting {
            background-color: #ff9800;
        }

        .connect-btn.connected {
            background-color: #4caf50;
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            display: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: linear-gradient(to bottom right, #0a0f2c, #162b6f);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fff;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 1rem 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        .category {
            margin-bottom: 1.5rem;
        }

        .category-header {
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            font-size: 0.9rem;
            color: #ccc;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .server-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .server-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .server-item.selected {
            background: rgba(159, 111, 242, 0.2);
            border-left: 3px solid #9f6ff2;
        }

        .server-icon {
            width: 42px;
            height: 42px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .server-info {
            flex: 1;
        }

        .server-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.25rem;
        }

        .server-details {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #ccc;
        }

        .server-mode {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .hidden {
            display: none !important;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 1.5rem;
            }

            .title {
                font-size: 1.6rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .modal {
                width: 95%;
                max-height: 85vh;
            }

            .server-details {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .network-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #b0bec5;
            font-size: 11px;
        }

        .info-value {
            color: #e3f2fd;
            font-weight: 500;
        }

        .icon {
            width: 14px;
            text-align: center;
        }

        .glow-icon {
            filter: drop-shadow(0 0 8px rgba(156, 39, 176, 0.6));
        }

        .user-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            backdrop-filter: blur(10px);
        }

        .user-info-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #9f6ff2, #f26fc7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-welcome {
            flex: 1;
        }

        .user-welcome h3 {
            margin: 0;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
        }

        .user-welcome p {
            margin: 0;
            color: #ccc;
            font-size: 0.8rem;
        }

        .user-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .stat-value {
            color: #fff;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .connecting-animation {
            display: none;
            text-align: center;
            padding: 1.5rem;
            color: #fff;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #9f6ff2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .connecting-text {
            color: #ccc;
            font-size: 0.9rem;
        }

        .input-field {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .input-field.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .user-info.fade-in {
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .menu-container {
            background: linear-gradient(to bottom right, #0a0f2c, #162b6f);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .menu-overlay.show .menu-container {
            transform: scale(1);
            opacity: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            margin-bottom: 0.8rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(159, 111, 242, 0.2);
        }

        .menu-item:last-child {
            margin-bottom: 0;
        }

        .menu-item i {
            font-size: 1.2rem;
            color: #9f6ff2;
            margin-right: 1rem;
            width: 20px;
        }

        .menu-content {
            flex: 1;
        }

        .menu-title {
            font-weight: bold;
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .menu-desc {
            color: #ccc;
            font-size: 0.75rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
            transition: background 0.3s ease;
        }

        .status-indicator.active {
            background: #4caf50;
        }

        .category-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .category-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .category-item-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .category-icon {
            width: 42px;
            height: 42px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 0.25rem;
        }

        .category-count {
            font-size: 0.8rem;
            color: #ccc;
        }

        .back-btn {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #9f6ff2;
            font-weight: bold;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .logo {
            width: 100%;
            max-width: 488px;
            height: auto;
            max-height: 113px;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <!-- Logo src was set by the removed obfuscated script. Reverting to empty src as per original HTML. -->
            <img src="" alt="vrconnect" class="logo" />
        </div>
        <div class="select-server" id="selectServer">
            <i class="fas fa-server"></i>
            <input type="text" placeholder="Selecione a operadora" readonly id="serverDisplay" />
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="input-field" id="usernameField">
            <i class="fas fa-user"></i>
            <input type="text" placeholder="Digite seu nome de usuário" id="usernameInput" />
        </div>
        <div class="input-field" id="passwordField">
            <i class="fas fa-lock"></i>
            <input type="password" placeholder="Digite sua senha" id="passwordInput" />
            <i class="fas fa-eye" id="togglePassword"></i>
        </div>
        <div class="input-field hidden" id="uuidField">
            <i class="fas fa-key"></i>
            <input type="text" placeholder="Digite seu UUID" id="uuidInput" />
        </div>
        <div class="connecting-animation" id="connectingAnimation">
            <div class="spinner"></div>
            <div class="connecting-text">Conectando e verificando dados...</div>
        </div>
        <div class="user-info" id="user-info">
            <div class="user-info-header">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-welcome">
                    <h3>Bem-vindo!</h3>
                    <p id="user-name">Carregando...</p>
                </div>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-label">Expira em</div>
                    <div class="stat-value" id="days-remaining">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Vencimento</div>
                    <div class="stat-value" id="user-expiry">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Conexões</div>
                    <div class="stat-value" id="usage-limit">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Status</div>
                    <div class="stat-value" style="color: #4caf50;">Ativo</div>
                </div>
            </div>
        </div>
        <div class="status">
            <i class="fas fa-circle" style="color: red;"></i> Status da conexão
        </div>
        <div class="action-buttons">
            <button class="action-btn" id="updateBtn">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="action-btn" id="debugBtn">
                <i class="fas fa-bug"></i> Logs
            </button>
            <button class="action-btn" id="menuBtn">
                <i class="fas fa-bars"></i><span>Menu</span>
            </button>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <button class="connect-btn" id="connectBtn">CONECTAR</button>
        <div class="network-info">
            <div class="info-item">
                <i class="fas fa-wifi icon glow-icon"></i><span>Rede: <span class="info-value" id="networkName">WIFI</span></span>
            </div>
            <div class="info-item">
                <i class="fas fa-tachometer-alt icon glow-icon"></i><span>Ping: <span class="info-value" id="pingResult">00ms</span></span>
            </div>
            <div class="info-item">
                <i class="fas fa-map-marker-alt icon glow-icon"></i><span>Local IP: <span class="info-value" id="localIP">192.168.3.5</span></span>
            </div>
            <div class="info-item">
                <i class="fas fa-code-branch icon glow-icon"></i><span>Versão: <span class="info-value" id="appVersion">19/4.4.6</span></span>
            </div>
        </div>
    </div>

    <div class="menu-overlay" id="menuOverlay">
        <div class="menu-container">
            <div class="menu-item" id="menuApn">
                <i class="fas fa-network-wired"></i>
                <div class="menu-content">
                    <div class="menu-title">APN</div>
                    <div class="menu-desc">Configurar ponto de acesso da rede</div>
                </div>
            </div>
            <div class="menu-item" id="menuBattery">
                <i class="fas fa-battery-full"></i>
                <div class="menu-content">
                    <div class="menu-title">BATERIA</div>
                    <div class="menu-desc">Otimizar uso da bateria</div>
                </div>
            </div>
            <div class="menu-item" id="menuHotspot">
                <i class="fas fa-wifi"></i>
                <div class="menu-content">
                    <div class="menu-title">HOTSPOT</div>
                    <div class="menu-desc">Compartilhar conexão</div>
                </div>
                <div class="status-indicator" id="hotspotStatus"></div>
            </div>
            <div class="menu-item" id="menuTerms">
                <i class="fas fa-file-contract"></i>
                <div class="menu-content">
                    <div class="menu-title">TERMOS</div>
                    <div class="menu-desc">Termos de uso e política</div>
                </div>
            </div>
            <div class="menu-item" id="menuClean">
                <i class="fas fa-trash"></i>
                <div class="menu-content">
                    <div class="menu-title">LIMPAR</div>
                    <div class="menu-desc">Limpar cache e dados temporários</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Selecionar Servidor</div>
                <button class="close-btn" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
        const selectServerBtn = document.getElementById("selectServer");
        const modalOverlay = document.getElementById("modalOverlay");
        const closeModalBtn = document.getElementById("closeModal");
        const modalBody = document.getElementById("modalBody");
        const serverDisplay = document.getElementById("serverDisplay");
        const usernameInput = document.getElementById("usernameInput");
        const passwordInput = document.getElementById("passwordInput");
        const uuidInput = document.getElementById("uuidInput");
        const uuidField = document.getElementById("uuidField");
        const usernameField = document.getElementById("usernameField");
        const passwordField = document.getElementById("passwordField");
        const togglePassword = document.getElementById("togglePassword");
        const connectBtn = document.getElementById("connectBtn");
        const updateBtn = document.getElementById("updateBtn");
        const debugBtn = document.getElementById("debugBtn");
        const errorMessage = document.getElementById("errorMessage");
        const connectingAnimation = document.getElementById("connectingAnimation");
        const networkNameEl = document.getElementById("networkName");
        const pingResultEl = document.getElementById("pingResult");
        const localIPEl = document.getElementById("localIP");
        const appVersionEl = document.getElementById("appVersion");
        const userInfo = document.getElementById("user-info");

        let currentConfig = null;
        let allConfigs = [];
        let vpnState = "DISCONNECTED";
        let userCredentials = { username: "", password: "", uuid: "" };

        // Update network info every 5 seconds
        setInterval(updateNetworkInfo, 5000);
        // Check VPN state every second
        setInterval(checkVpnState, 1000);

        /**
         * Updates the app version and config version display.
         * Tries to get versions from DtGetLocalConfigVersion and DtAppVersion methods.
         */
        function updateVersionInfo() {
            let configVersion = "-";
            let appVersion = "-";
            try {
                if (window.DtGetLocalConfigVersion && typeof window.DtGetLocalConfigVersion.execute === "function") {
                    const version = window.DtGetLocalConfigVersion.execute();
                    if (version) configVersion = version;
                }
            } catch (e) {
                console.error("Erro ao obter versão da configuração:", e);
            }
            try {
                if (window.DtAppVersion && typeof window.DtAppVersion.execute === "function") {
                    const version = window.DtAppVersion.execute();
                    if (version) appVersion = version;
                }
            } catch (e) {
                console.error("Erro ao obter versão do aplicativo:", e);
            }
            if (appVersionEl) {
                appVersionEl.textContent = `${configVersion}/${appVersion}`;
            }
        }

        /**
         * Saves a key-value pair to localStorage.
         * @param {string} key - The key to store the value under.
         * @param {string} value - The value to store.
         */
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(`tunnelx_${key}`, value);
            } catch (error) {
                console.error("Error saving to localStorage:", error);
            }
        }

        /**
         * Loads a value from localStorage.
         * @param {string} key - The key of the value to load.
         * @returns {string} The loaded value, or an empty string if not found or an error occurs.
         */
        function loadFromLocalStorage(key) {
            try {
                return localStorage.getItem(`tunnelx_${key}`) || "";
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                return "";
            }
        }

        /**
         * Loads user credentials (username, password, UUID) from localStorage
         * into the `userCredentials` object.
         */
        function loadUserCredentials() {
            const savedUsername = loadFromLocalStorage("username");
            const savedPassword = loadFromLocalStorage("password");
            const savedUuid = loadFromLocalStorage("uuid");
            userCredentials.username = savedUsername;
            userCredentials.password = savedPassword;
            userCredentials.uuid = savedUuid;
        }

        /**
         * Applies the loaded user credentials to the respective input fields.
         */
        function applyUserCredentialsToInputs() {
            usernameInput.value = userCredentials.username;
            passwordInput.value = userCredentials.password;
            uuidInput.value = userCredentials.uuid;
        }

        /**
         * Updates the displayed network information (name, local IP, ping result)
         * by calling native functions through `window.Dt*` methods.
         */
        function updateNetworkInfo() {
            try {
                const networkName = window.DtGetNetworkName?.execute() || "WIFI";
                const localIP = window.DtGetLocalIP?.execute() || "192.168.3.5";
                const pingResult = window.DtGetPingResult?.execute() || "00ms";
                networkNameEl.textContent = networkName;
                localIPEl.textContent = localIP;
                pingResultEl.textContent = pingResult;
            } catch (error) {
                console.error("Error updating network info:", error);
            }
        }

        /**
         * Checks the current VPN state and updates the UI accordingly.
         * Uses `window.DtGetVpnState` to get the state.
         */
        function checkVpnState() {
            try {
                const state = window.DtGetVpnState?.execute();
                if (state && state !== vpnState) {
                    vpnState = state;
                    updateUI();
                }
            } catch (error) {
                console.error("Error checking VPN state:", error);
            }
        }

        /**
         * Updates the UI elements based on the current `vpnState`.
         * Changes button text/class, status icon/text, and input field visibility/disability.
         */
        function updateUI() {
            const isConnecting = vpnState === "CONNECTING";
            const isConnected = vpnState === "CONNECTED";
            const isDisconnected = vpnState === "DISCONNECTED";

            connectBtn.classList.remove("connecting", "connected");

            if (isConnecting) {
                connectBtn.classList.add("connecting");
                connectBtn.textContent = "CONECTANDO...";
                showConnectingAnimation();
            } else if (isConnected) {
                connectBtn.classList.add("connected");
                connectBtn.textContent = "DESCONECTAR";
                hideConnectingAnimation();
                showUserInfo();
            } else {
                connectBtn.textContent = "CONECTAR";
                hideConnectingAnimation();
                hideUserInfo();
                showInputFields();
            }

            const inputFields = document.querySelectorAll(".input-field");
            inputFields.forEach((field) => {
                if (isDisconnected) {
                    field.classList.remove("disabled");
                } else {
                    field.classList.add("disabled");
                }
            });

            const statusElement = document.querySelector(".status");
            const statusIcon = statusElement.querySelector("i");

            switch (vpnState) {
                case "CONNECTED":
                    statusIcon.style.color = "green";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: green;"></i> VOCÊ ESTÁ CONECTADO A INTERNET';
                    break;
                case "CONNECTING":
                    statusIcon.style.color = "orange";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: orange;"></i> Conectando...';
                    break;
                case "STOPPING":
                    statusIcon.style.color = "orange";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: orange;"></i> Desconectando...';
                    break;
                case "AUTH_FAILED":
                    statusIcon.style.color = "red";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: red;"></i> Falha na autenticação';
                    break;
                case "NO_NETWORK":
                    statusIcon.style.color = "red";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: red;"></i> Sem rede';
                    break;
                default:
                    statusIcon.style.color = "red";
                    statusElement.innerHTML = '<i class="fas fa-circle" style="color: red;"></i> Desconectado';
            }
        }

        /**
         * Displays an error message in the `errorMessage` element.
         * The message disappears after 5 seconds.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = "block";
            setTimeout(() => {
                errorMessage.style.display = "none";
            }, 5000);
        }

        /**
         * Validates the connection attempt.
         * Checks if a server is selected and if required authentication data (username/password or UUID for V2Ray) is provided.
         * @returns {boolean} True if validation passes, false otherwise.
         */
        function validateConnection() {
            if (!currentConfig) {
                showError("Selecione um servidor antes de conectar");
                return false;
            }

            const isV2ray = currentConfig.mode && currentConfig.mode.toLowerCase().includes("v2ray");
            const hasAuthData = currentConfig.auth && (currentConfig.auth.username || currentConfig.auth.password || currentConfig.auth.uuid);

            if (hasAuthData) {
                return true; // Config has built-in auth, no need for user input validation
            }

            if (isV2ray) {
                if (!uuidInput.value.trim()) {
                    showError("Digite o UUID para conexões V2Ray");
                    return false;
                }
            } else {
                if (!usernameInput.value.trim() || !passwordInput.value.trim()) {
                    showError("Digite o usuário e senha para conectar");
                    return false;
                }
            }
            return true;
        }

        /**
         * Starts the VPN connection by calling `window.DtExecuteVpnStart`.
         * Includes validation before attempting connection.
         */
        function appStartConnection() {
            if (!validateConnection()) return;
            try {
                window.DtExecuteVpnStart?.execute();
            } catch (error) {
                console.error("Erro ao iniciar VPN:", error);
            }
        }

        /**
         * Stops the VPN connection by calling `window.DtExecuteVpnStop`.
         */
        function appStopConnection() {
            try {
                window.DtExecuteVpnStop?.execute();
            } catch (error) {
                console.error("Error stopping VPN:", error);
            }
        }

        // Toggle password visibility
        togglePassword.addEventListener("click", () => {
            const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
            passwordInput.setAttribute("type", type);
            togglePassword.classList.toggle("fa-eye");
            togglePassword.classList.toggle("fa-eye-slash");
        });

        // Event listener for Update button
        updateBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            try {
                window.DtStartAppUpdate?.execute();
                showError("Procurando Atualização...");
            } catch (error) {
                console.error("Error updating app:", error);
                showError("Erro ao iniciar atualização");
            }
        });

        // Event listener for Debug button
        debugBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            try {
                window.DtShowLoggerDialog?.execute();
            } catch (error) {
                console.error("Error showing logs:", error);
            }
        });

        // Event listener for Connect/Disconnect button
        connectBtn.addEventListener("click", () => {
            const state = vpnState;
            if (state !== "DISCONNECTED") {
                appStopConnection();
            } else {
                appStartConnection();
            }
        });

        // Open server selection modal
        selectServerBtn.addEventListener("click", () => {
            loadServers();
            modalOverlay.style.display = "flex";
        });

        // Close server selection modal
        closeModalBtn.addEventListener("click", closeModal);
        modalOverlay.addEventListener("click", (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        /**
         * Closes the server selection modal.
         */
        function closeModal() {
            modalOverlay.style.display = "none";
        }

        /**
         * Loads server configurations by calling `window.DtGetConfigs`.
         * Parses and sorts the configurations, then renders them in the modal.
         */
        function loadServers() {
            try {
                const configsData = window.DtGetConfigs?.execute();
                if (configsData) {
                    allConfigs = JSON.parse(configsData);
                    allConfigs.sort((a, b) => (a.sorter || 0) - (b.sorter || 0)); // Sort categories
                    allConfigs.forEach((category) => {
                        if (category.items) {
                            category.items.sort((a, b) => (a.sorter || 0) - (b.sorter || 0)); // Sort items within categories
                        }
                    });
                    currentView = "categories"; // Start with categories view
                    selectedCategory = null;
                    renderServers();
                }
            } catch (error) {
                console.error("Error loading servers:", error);
                modalBody.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ccc;">Erro ao carregar servidores</div>';
            }
        }

        let currentView = "categories"; // 'categories' or 'servers'
        let selectedCategory = null; // Stores the currently selected category object

        /**
         * Renders the server list in the modal, either as categories or as servers within a selected category.
         */
        function renderServers() {
            const currentConfigData = getCurrentConfig();
            modalBody.innerHTML = ""; // Clear existing content

            if (currentView === "categories") {
                renderCategories();
            } else {
                renderCategoryServers();
            }
        }

        /**
         * Renders the list of server categories in the modal.
         */
        function renderCategories() {
            allConfigs.forEach((category) => {
                if (!category.items || category.items.length === 0) return; // Skip empty categories

                const categoryItem = document.createElement("div");
                categoryItem.className = "category-item";
                categoryItem.innerHTML = `
                    <div class="category-item-content">
                        <img src="${category.items[0].icon || "https://placehold.co/32x32/162b6f/FFFFFF?text=IMG"}" alt="${ category.name }" class="category-icon" onerror="this.src='https://placehold.co/32x32/162b6f/FFFFFF?text=IMG'">
                        <div class="category-info">
                            <div class="category-name" style="color: #228B22; font-weight: bold;">${ category.name }</div>
                            <div class="category-count">${category.items.length} servidor${category.items.length > 1 ? "es" : ""}</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-right" style="color: #ccc;"></i>
                `;
                categoryItem.addEventListener("click", () => {
                    selectedCategory = category;
                    currentView = "servers";
                    renderServers(); // Re-render to show servers in this category
                });
                modalBody.appendChild(categoryItem);
            });
        }

        /**
         * Renders the list of servers within the currently selected category.
         */
        function renderCategoryServers() {
            const currentConfigData = getCurrentConfig();

            // Back button
            const backBtn = document.createElement("div");
            backBtn.className = "back-btn";
            backBtn.innerHTML = `
                <i class="fas fa-arrow-left"></i><span>Voltar</span>
            `;
            backBtn.addEventListener("click", () => {
                currentView = "categories";
                selectedCategory = null; // Clear selected category
                renderServers(); // Re-render to show categories
            });
            modalBody.appendChild(backBtn);

            const categoryDiv = document.createElement("div");
            categoryDiv.className = "category";

            const categoryHeader = document.createElement("div");
            categoryHeader.className = "category-header";
            categoryHeader.textContent = selectedCategory.name;
            categoryHeader.style.color = "#228B22";
            categoryHeader.style.fontWeight = "bold";
            categoryDiv.appendChild(categoryHeader);

            selectedCategory.items.forEach((item) => {
                const serverItem = document.createElement("div");
                serverItem.className = "server-item";
                // Add 'selected' class if this is the currently active config
                if (currentConfigData && currentConfigData.id === item.id) {
                    serverItem.classList.add("selected");
                }
                serverItem.innerHTML = `
                    <img src="${item.icon || "https://placehold.co/32x32/162b6f/FFFFFF?text=IMG"}" alt="${ item.name }" class="server-icon" onerror="this.src='https://placehold.co/32x32/162b6f/FFFFFF?text=IMG'">
                    <div class="server-info">
                        <div class="server-name">${item.name}</div>
                        <div class="server-details">
                            <span class="server-mode">${ item.mode }</span>
                            <span>${item.description || ""}</span>
                        </div>
                    </div>
                `;
                serverItem.addEventListener("click", (event) => selectServer(item, event)); // Pass event to selectServer
                categoryDiv.appendChild(serverItem);
            });
            modalBody.appendChild(categoryDiv);
        }

        /**
         * Selects a server configuration.
         * Sets the config via `window.DtSetConfig`, updates display, and adjusts input fields visibility.
         * @param {object} config - The selected server configuration object.
         * @param {Event} event - The click event that triggered this function.
         */
        function selectServer(config, event) {
            try {
                window.DtSetConfig?.execute(config.id);
                currentConfig = config; // Set the global currentConfig
                serverDisplay.value = config.name;

                // Remove 'selected' class from all server items
                document.querySelectorAll(".server-item").forEach((item) => {
                    item.classList.remove("selected");
                });
                // Add 'selected' class to the clicked item
                event.target.closest(".server-item").classList.add("selected");

                updateInputFields(config);

                // Populate input fields based on selected config's auth or saved credentials
                const updatedConfig = getCurrentConfig(); // Get the config that was just set (might be a different object instance)
                if (updatedConfig && updatedConfig.auth) {
                    const { username, password, uuid } = updatedConfig.auth;
                    if (username) {
                        usernameInput.value = username;
                        window.DtUsername?.set(username);
                    } else {
                        usernameInput.value = userCredentials.username;
                        window.DtUsername?.set(userCredentials.username);
                    }
                    if (password) {
                        passwordInput.value = password;
                        window.DtPassword?.set(password);
                    } else {
                        passwordInput.value = userCredentials.password;
                        window.DtPassword?.set(userCredentials.password);
                    }
                    if (uuid) {
                        uuidInput.value = uuid;
                        window.DtUuid?.set(uuid);
                    } else {
                        uuidInput.value = userCredentials.uuid;
                        window.DtUuid?.set(userCredentials.uuid);
                    }
                } else {
                    applyUserCredentialsToInputs(); // Apply previously saved credentials
                    window.DtUsername?.set(userCredentials.username);
                    window.DtPassword?.set(userCredentials.password);
                    window.DtUuid?.set(userCredentials.uuid);
                }
                closeModal();
            } catch (error) {
                console.error("Error selecting server:", error);
            }
        }

        /**
         * Updates the visibility of username, password, and UUID input fields
         * based on the selected server configuration's authentication requirements.
         * @param {object} config - The selected server configuration.
         */
        function updateInputFields(config) {
            usernameField.classList.add("hidden");
            passwordField.classList.add("hidden");
            uuidField.classList.add("hidden");

            const updatedConfig = getCurrentConfig(); // Get the latest config after it's set natively
            const configToCheck = updatedConfig || config; // Use the one from native if available, else fallback to passed config

            const isV2ray = configToCheck.mode && configToCheck.mode.toLowerCase().includes("v2ray");
            const hasAuthData = configToCheck.auth && (configToCheck.auth.username || configToCheck.auth.password || configToCheck.auth.uuid);

            // If the config itself has auth data, hide all input fields as they are not needed for user input
            if (!hasAuthData) {
                if (isV2ray) {
                    uuidField.classList.remove("hidden");
                } else {
                    usernameField.classList.remove("hidden");
                    passwordField.classList.remove("hidden");
                }
            }
        }

        /**
         * Retrieves the currently set default configuration from the native side.
         * @returns {object|null} The current configuration object, or null if an error occurs.
         */
        function getCurrentConfig() {
            try {
                const configData = window.DtGetDefaultConfig?.execute();
                if (configData) {
                    return typeof configData === "string" ? JSON.parse(configData) : configData;
                }
            } catch (error) {
                console.error("Error getting current config:", error);
            }
            return null;
        }

        /**
         * Shows the connecting animation and hides input fields and user info.
         */
        function showConnectingAnimation() {
            hideInputFields();
            connectingAnimation.style.display = "block";
            userInfo.style.display = "none";
        }

        /**
         * Hides the connecting animation.
         */
        function hideConnectingAnimation() {
            connectingAnimation.style.display = "none";
        }

        /**
         * Hides input fields with a fade-out animation.
         */
        function hideInputFields() {
            const visibleFields = document.querySelectorAll(".input-field:not(.hidden)");
            visibleFields.forEach((field) => {
                field.classList.add("fade-out");
                setTimeout(() => {
                    field.style.display = "none";
                }, 300); // Wait for animation to complete before hiding
            });
        }

        /**
         * Shows input fields and removes fade-out animation.
         * Re-applies visibility based on current config.
         */
        function showInputFields() {
            const inputFields = [usernameField, passwordField, uuidField];
            inputFields.forEach((field) => {
                field.style.display = "flex"; // Ensure it's visible before removing fade-out
                field.classList.remove("fade-out");
            });
            if (currentConfig) {
                updateInputFields(currentConfig); // Re-apply correct visibility based on selected config
            }
        }

        /**
         * Shows the user information section and loads user data.
         */
        function showUserInfo() {
            // Hide all input fields explicitly
            const inputFields = [usernameField, passwordField, uuidField];
            inputFields.forEach((field) => {
                field.style.display = "none";
            });

            userInfo.style.display = "block";
            userInfo.classList.add("fade-in");
            loadUserData(); // Load saved user data from local storage

            // Attempt to get fresh user info from native side
            try {
                if (window.DtGetUserInfo && typeof window.DtGetUserInfo.execute === "function") {
                    const userInfoData = window.DtGetUserInfo.execute();
                    if (userInfoData) {
                        dtCheckUserModelListener(userInfoData); // Process fresh data
                    }
                }
            } catch (error) {
                console.error("Erro ao buscar informações do usuário:", error);
            }
        }

        /**
         * Hides the user information section.
         */
        function hideUserInfo() {
            userInfo.style.display = "none";
            userInfo.classList.remove("fade-in"); // Remove fade-in class
        }

        /**
         * Processes user model data received from the native side and updates the UI.
         * Also saves user data to local storage.
         * @param {string} userDataJson - JSON string of user data.
         */
        function dtCheckUserModelListener(userDataJson) {
            try {
                const t = JSON.parse(userDataJson);
                const userNameEl = document.getElementById("user-name");
                const userExpiryEl = document.getElementById("user-expiry");
                const daysRemainingEl = document.getElementById("days-remaining");
                const usageLimitEl = document.getElementById("usage-limit");
                const userAvatarEl = document.getElementById("user-avatar");

                userInfo.style.display = "block"; // Ensure user info is visible

                const username = t.username || "-";
                userNameEl.textContent = username;
                userExpiryEl.textContent = t.expiration_date || "-";
                daysRemainingEl.textContent = t.expiration_days ? `${t.expiration_days} dias` : "-";
                usageLimitEl.textContent = t.limit_connections ? `${t.count_connections || 0}/${t.limit_connections}` : "-";

                if (username && username !== "-") {
                    userAvatarEl.textContent = username.charAt(0).toUpperCase();
                }

                // Save updated user data to local storage
                saveToLocalStorage(
                    "user_data",
                    JSON.stringify({
                        username: username,
                        expiration_date: t.expiration_date || "-",
                        expiration_days: t.expiration_days || "-",
                        limit_connections: t.limit_connections || "-",
                        count_connections: t.count_connections || 0,
                    })
                );
            } catch (e) {
                console.error("Erro ao processar dados do usuário:", e);
            }
        }

        /**
         * Loads and displays saved user data from local storage.
         */
        function loadUserData() {
            try {
                const savedUserData = loadFromLocalStorage("user_data");
                if (savedUserData) {
                    const userData = JSON.parse(savedUserData);
                    const userNameEl = document.getElementById("user-name");
                    const userExpiryEl = document.getElementById("user-expiry");
                    const daysRemainingEl = document.getElementById("days-remaining");
                    const usageLimitEl = document.getElementById("usage-limit");
                    const userAvatarEl = document.getElementById("user-avatar");

                    userNameEl.textContent = userData.username;
                    userExpiryEl.textContent = userData.expiration_date;
                    daysRemainingEl.textContent = userData.expiration_days !== "-" ? `${userData.expiration_days} dias` : "-";
                    usageLimitEl.textContent = userData.limit_connections !== "-" ? `${userData.count_connections}/${userData.limit_connections}` : "-";

                    if (userData.username && userData.username !== "-") {
                        userAvatarEl.textContent = userData.username.charAt(0).toUpperCase();
                    }
                }
            } catch (error) {
                console.error("Erro ao carregar dados do usuário:", error);
            }
        }

        // Event listeners for input fields to save credentials and update native side
        usernameInput.addEventListener("input", () => {
            userCredentials.username = usernameInput.value;
            saveToLocalStorage("username", usernameInput.value);
            try {
                window.DtUsername?.set(usernameInput.value);
            } catch (error) {
                console.error("Error saving username:", error);
            }
        });

        passwordInput.addEventListener("input", () => {
            userCredentials.password = passwordInput.value;
            saveToLocalStorage("password", passwordInput.value);
            try {
                window.DtPassword?.set(passwordInput.value);
            } catch (error) {
                console.error("Error saving password:", error);
            }
        });

        uuidInput.addEventListener("input", () => {
            userCredentials.uuid = uuidInput.value;
            saveToLocalStorage("uuid", uuidInput.value);
            try {
                window.DtUuid?.set(uuidInput.value);
            } catch (error) {
                console.error("Error saving UUID:", error);
            }
        });

        // Initialize on DOM content loaded
        document.addEventListener("DOMContentLoaded", () => {
            try {
                loadUserCredentials(); // Load saved credentials first
                loadUserData(); // Load saved user display data
                updateNetworkInfo(); // Update network display
                updateVersionInfo(); // Update version display

                const currentConfigData = getCurrentConfig(); // Get the default config from native
                if (currentConfigData) {
                    serverDisplay.value = currentConfigData.name;
                    currentConfig = currentConfigData; // Set the global currentConfig
                    updateInputFields(currentConfigData); // Adjust input fields visibility

                    // Pre-fill inputs if config has auth or use saved ones
                    if (currentConfigData.auth) {
                        const { username, password, uuid } = currentConfigData.auth;
                        if (username) {
                            usernameInput.value = username;
                        } else {
                            usernameInput.value = userCredentials.username; // Fallback to saved
                        }
                        if (password) {
                            passwordInput.value = password;
                        } else {
                            passwordInput.value = userCredentials.password; // Fallback to saved
                        }
                        if (uuid) {
                            uuidInput.value = uuid;
                        } else {
                            uuidInput.value = userCredentials.uuid; // Fallback to saved
                        }
                    } else {
                        applyUserCredentialsToInputs(); // Apply previously saved credentials if no config auth
                    }
                } else {
                    applyUserCredentialsToInputs(); // If no default config, just apply saved credentials
                }

                checkVpnState(); // Check initial VPN state
                updateUI(); // Update UI based on initial VPN state
            } catch (error) {
                console.error("Error during initialization:", error);
            }
        });
    </script>

    <script>
        const menuBtn = document.getElementById("menuBtn");
        const menuOverlay = document.getElementById("menuOverlay");
        const hotspotStatus = document.getElementById("hotspotStatus");

        // Event listener to show the menu overlay
        menuBtn.addEventListener("click", (e) => {
            e.stopPropagation(); // Prevent click from bubbling up and closing modal
            menuOverlay.style.display = "flex";
            // Add 'show' class after a slight delay to trigger CSS transition
            setTimeout(() => {
                menuOverlay.classList.add("show");
            }, 10);
            updateHotspotStatus(); // Update hotspot status when menu opens
        });

        // Close menu if clicking outside the menu container
        menuOverlay.addEventListener("click", (e) => {
            if (e.target === menuOverlay) {
                closeMenu();
            }
        });

        /**
         * Closes the menu overlay with a transition.
         */
        function closeMenu() {
            menuOverlay.classList.remove("show");
            // Hide the overlay completely after the transition
            setTimeout(() => {
                menuOverlay.style.display = "none";
            }, 300);
        }

        // Menu item for APN settings
        document.getElementById("menuApn").addEventListener("click", () => {
            try {
                window.DtStartApnActivity?.execute();
                closeMenu();
            } catch (error) {
                console.error("Error opening APN settings:", error);
            }
        });

        // Menu item for Battery optimization settings
        document.getElementById("menuBattery").addEventListener("click", () => {
            try {
                window.DtIgnoreBatteryOptimizations?.execute();
                closeMenu();
            } catch (error) {
                console.error("Error opening battery settings:", error);
            }
        });

        // Menu item for Hotspot toggle
        document.getElementById("menuHotspot").addEventListener("click", () => {
            toggleHotspot();
            closeMenu();
        });

        // Menu item for cleaning app cache/data
        document.getElementById("menuClean").addEventListener("click", () => {
            try {
                window.DtCleanApp?.execute();
                showError("Limpeza realizada com sucesso");
                closeMenu();
            } catch (error) {
                console.error("Error cleaning app:", error);
                showError("Erro ao limpar aplicativo");
            }
        });

        // Menu item for Terms and Privacy Policy (opens in WebView)
        const menuTermsElement = document.getElementById("menuTerms");
        if (menuTermsElement) {
            menuTermsElement.addEventListener("click", () => {
                try {
                    // This URL should point to your terms of use page
                    window.DtStartWebViewActivity.execute("https://cls.developerws.com/termos/index.html");
                    closeMenu();
                } catch (error) {
                    console.error("Error opening terms:", error);
                }
            });
        }

        /**
         * Updates the visual status indicator for the Hotspot in the menu.
         */
        function updateHotspotStatus() {
            try {
                const status = window.DtGetStatusHotSpotService?.execute() || "STOPPED";
                if (status === "RUNNING") {
                    hotspotStatus.classList.add("active");
                } else {
                    hotspotStatus.classList.remove("active");
                }
            } catch (error) {
                console.error("Error updating hotspot status:", error);
            }
        }

        /**
         * Toggles the Hotspot service (start/stop) and updates its status.
         */
        function toggleHotspot() {
            try {
                const e = window.DtGetStatusHotSpotService?.execute() || "STOPPED";
                if (e === "RUNNING") {
                    if (window.DtStopHotSpotService?.execute) {
                        window.DtStopHotSpotService.execute();
                    }
                } else {
                    if (window.DtStartHotSpotService?.execute) {
                        window.DtStartHotSpotService.execute();
                    }
                }
                // Give a short delay for the native service to update its state
                setTimeout(updateHotspotStatus, 1000);
            } catch (e) {
                // Using showError instead of showAlert for consistency
                showError("Erro ao alterar hotspot");
                console.error("Erro ao alterar hotspot:", e);
            }
        }
    </script>
</body>
</html>